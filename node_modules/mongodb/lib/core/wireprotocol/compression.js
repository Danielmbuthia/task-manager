'use strict';

<<<<<<< HEAD
const Snappy = require('../connection/utils').retrieveSnappy();
const zlib = require('zlib');

const compressorIDs = {
=======
var Snappy = require('../connection/utils').retrieveSnappy(),
  zlib = require('zlib');

var compressorIDs = {
>>>>>>> a443bfadc7c360f7746f21df0eaacc47f1521bf0
  snappy: 1,
  zlib: 2
};

<<<<<<< HEAD
const uncompressibleCommands = new Set([
=======
var uncompressibleCommands = [
>>>>>>> a443bfadc7c360f7746f21df0eaacc47f1521bf0
  'ismaster',
  'saslStart',
  'saslContinue',
  'getnonce',
  'authenticate',
  'createUser',
  'updateUser',
  'copydbSaslStart',
  'copydbgetnonce',
  'copydb'
<<<<<<< HEAD
]);

// Facilitate compressing a message using an agreed compressor
function compress(self, dataToBeCompressed, callback) {
=======
];

// Facilitate compressing a message using an agreed compressor
var compress = function(self, dataToBeCompressed, callback) {
>>>>>>> a443bfadc7c360f7746f21df0eaacc47f1521bf0
  switch (self.options.agreedCompressor) {
    case 'snappy':
      Snappy.compress(dataToBeCompressed, callback);
      break;
    case 'zlib':
      // Determine zlibCompressionLevel
      var zlibOptions = {};
      if (self.options.zlibCompressionLevel) {
        zlibOptions.level = self.options.zlibCompressionLevel;
      }
      zlib.deflate(dataToBeCompressed, zlibOptions, callback);
      break;
    default:
      throw new Error(
        'Attempt to compress message using unknown compressor "' +
          self.options.agreedCompressor +
          '".'
      );
  }
<<<<<<< HEAD
}

// Decompress a message using the given compressor
function decompress(compressorID, compressedData, callback) {
=======
};

// Decompress a message using the given compressor
var decompress = function(compressorID, compressedData, callback) {
>>>>>>> a443bfadc7c360f7746f21df0eaacc47f1521bf0
  if (compressorID < 0 || compressorID > compressorIDs.length) {
    throw new Error(
      'Server sent message compressed using an unsupported compressor. (Received compressor ID ' +
        compressorID +
        ')'
    );
  }
  switch (compressorID) {
    case compressorIDs.snappy:
      Snappy.uncompress(compressedData, callback);
      break;
    case compressorIDs.zlib:
      zlib.inflate(compressedData, callback);
      break;
    default:
      callback(null, compressedData);
  }
<<<<<<< HEAD
}

module.exports = {
  compressorIDs,
  uncompressibleCommands,
  compress,
  decompress
=======
};

module.exports = {
  compressorIDs: compressorIDs,
  uncompressibleCommands: uncompressibleCommands,
  compress: compress,
  decompress: decompress
>>>>>>> a443bfadc7c360f7746f21df0eaacc47f1521bf0
};
